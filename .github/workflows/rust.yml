name: Rust CI

on:
  push:
    branches: ["master"]
    tags: ["v*"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read

concurrency:
  group: rust-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Lint ──────────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clang lld

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: rustfmt
        run: cargo fmt --all --check

      - name: clippy (default)
        run: cargo clippy --locked -- -D warnings

      - name: clippy (nojit)
        run: cargo clippy --locked --features nojit -- -D warnings

      - name: Warnings gate
        run: |
          RUSTFLAGS="-D warnings" cargo check --locked
          RUSTFLAGS="-D warnings" cargo check --locked --features nojit

  # ── Linux GNU ─────────────────────────────────────────────────────────────
  test-linux-gnu:
    name: Linux GNU x86_64
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clang lld

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: Test (default)
        env:
          RUSTDOCFLAGS: "-C target-cpu=native -C link-arg=-fuse-ld=lld"
        run: cargo test --release --locked

      - name: Test (nojit)
        env:
          RUSTDOCFLAGS: "-C target-cpu=native -C link-arg=-fuse-ld=lld"
        run: cargo test --release --locked --features nojit

  # ── Linux musl ────────────────────────────────────────────────────────────
  test-linux-musl:
    name: Linux musl x86_64
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache musl toolchain + target artifacts
        uses: actions/cache@v4
        with:
          path: |
            .ci-cache/musl/cargo
            .ci-cache/musl/rustup
            target/x86_64-unknown-linux-musl
          key: ${{ runner.os }}-musl-alpine-3.23.3-${{ hashFiles('Cargo.lock', '.github/workflows/rust.yml') }}
          restore-keys: |
            ${{ runner.os }}-musl-alpine-3.23.3-

      - name: Test in Alpine (musl)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci-cache/musl/cargo .ci-cache/musl/rustup
          docker run --rm \
            -v "$PWD:/work" \
            -v "$PWD/.ci-cache/musl/cargo:/root/.cargo" \
            -v "$PWD/.ci-cache/musl/rustup:/root/.rustup" \
            -w /work \
            -e CARGO_TERM_COLOR=always \
            alpine:3.23.3 \
            sh -euxc '
              apk add --no-cache bash build-base clang lld curl ca-certificates git musl-dev
              if ! command -v rustup >/dev/null 2>&1; then
                curl -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal --default-toolchain stable
              fi
              . /root/.cargo/env
              rustup toolchain install stable --profile minimal --no-self-update
              rustup default stable
              rustup target add x86_64-unknown-linux-musl

              gcc_ver="$(g++ -dumpversion)"
              cxx_base="/usr/include/c++/${gcc_ver}"
              export CC_x86_64_unknown_linux_musl=clang
              export CXX_x86_64_unknown_linux_musl=clang++
              export CFLAGS_x86_64_unknown_linux_musl="--gcc-toolchain=/usr"
              export CXXFLAGS_x86_64_unknown_linux_musl="--gcc-toolchain=/usr -isystem ${cxx_base} -isystem ${cxx_base}/x86_64-alpine-linux-musl -isystem ${cxx_base}/backward"
              export CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=clang
              export MUSL_LD_RUSTFLAGS="-C link-arg=-fuse-ld=lld"

              RUSTFLAGS="-D warnings ${MUSL_LD_RUSTFLAGS}" cargo check --target x86_64-unknown-linux-musl --locked
              RUSTFLAGS="-D warnings ${MUSL_LD_RUSTFLAGS}" cargo check --target x86_64-unknown-linux-musl --locked --features nojit

              RUSTFLAGS="${MUSL_LD_RUSTFLAGS}" cargo test --release --target x86_64-unknown-linux-musl --locked
              RUSTFLAGS="${MUSL_LD_RUSTFLAGS}" cargo test --release --target x86_64-unknown-linux-musl --locked --features nojit
            '

  # ── macOS ─────────────────────────────────────────────────────────────────
  test-macos:
    name: macOS
    needs: lint
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: Test (default)
        env:
          RUSTDOCFLAGS: "-C target-cpu=native"
        run: cargo test --release --locked

      - name: Test (nojit)
        env:
          RUSTDOCFLAGS: "-C target-cpu=native"
        run: cargo test --release --locked --features nojit

  # ── Windows ───────────────────────────────────────────────────────────────
  test-windows:
    name: Windows x86_64
    needs: lint
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: Test (default)
        run: cargo test --release --locked

      - name: Test (nojit)
        run: cargo test --release --locked --features nojit

  # ── BSDs ──────────────────────────────────────────────────────────────────
  test-bsd:
    name: BSD ${{ matrix.os }} ${{ matrix.version }}
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: freebsd
            version: "15.0"
            rustdocflags: "-C target-cpu=native -C link-arg=-fuse-ld=lld"
          - os: openbsd
            version: "7.8"
            rustdocflags: "-C target-cpu=native -C link-arg=-fuse-ld=lld"
          - os: netbsd
            version: "10.1"
            # NetBSD: skip LTO on linker side (archive toolchain lacks the LTO plugin)
            rustdocflags: "-C target-cpu=native"
    steps:
      - uses: actions/checkout@v4

      - name: Test on ${{ matrix.os }} ${{ matrix.version }}
        uses: cross-platform-actions/action@v0.32.0
        with:
          operating_system: ${{ matrix.os }}
          version: ${{ matrix.version }}
          architecture: x86_64
          memory: 6G
          environment_variables: CARGO_TERM_COLOR
          shell: sh
          run: |
            set -eu

            # Portable privilege escalation helper
            as_root() {
              if command -v sudo >/dev/null 2>&1; then
                sudo "$@"
              elif command -v doas >/dev/null 2>&1; then
                doas "$@"
              else
                "$@"
              fi
            }

            # Install Rust via the system package manager, then fall back to rustup
            ensure_rust() {
              if command -v cargo >/dev/null 2>&1; then
                return 0
              fi
              if command -v pkg >/dev/null 2>&1; then
                as_root pkg update -f || true
                as_root pkg install -y rust || true
              elif command -v pkgin >/dev/null 2>&1; then
                as_root pkgin -y update || true
                as_root pkgin -y install rust || true
              elif command -v pkg_add >/dev/null 2>&1; then
                as_root pkg_add rust || true
              fi
              if ! command -v cargo >/dev/null 2>&1; then
                if command -v curl >/dev/null 2>&1; then
                  curl -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
                elif command -v ftp >/dev/null 2>&1; then
                  ftp -o /tmp/rustup-init.sh https://sh.rustup.rs
                  sh /tmp/rustup-init.sh -y --profile minimal
                else
                  echo "Unable to install Rust toolchain in BSD runner" >&2
                  exit 1
                fi
              fi
            }

            ensure_rust
            export PATH="/usr/local/bin:/usr/pkg/bin:$HOME/.cargo/bin:$PATH"
            cargo --version
            rustc --version

            OS="$(uname -s)"
            case "$OS" in
              NetBSD)
                # JIT codegen is broken on NetBSD; disable it
                export CARGO_FEATURE_NOJIT=1
                # C++ LTO on NetBSD drops symbols from archives; build.rs
                # already gates -flto on target_os != "netbsd", but also
                # disable Rust-side LTO to be safe
                export CARGO_PROFILE_RELEASE_LTO=off
                # Use the system linker if clang is absent
                if ! command -v clang >/dev/null 2>&1 && command -v cc >/dev/null 2>&1; then
                  export CARGO_TARGET_X86_64_UNKNOWN_NETBSD_LINKER=cc
                fi
                ;;
              OpenBSD)
                # JIT codegen is broken on OpenBSD
                export CARGO_FEATURE_NOJIT=1
                ;;
              FreeBSD)
                # No special flags needed
                ;;
            esac

            export RUSTDOCFLAGS="${{ matrix.rustdocflags }}"

            RUSTFLAGS="-D warnings" cargo check --locked
            RUSTFLAGS="-D warnings" cargo check --locked --features nojit

            cargo test --release --locked
